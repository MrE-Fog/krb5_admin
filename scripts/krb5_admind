#!/usr/pkg/bin/perl

use Getopt::Std;
use Sys::Hostname;
use Sys::Syslog;

use Krb5Admin::Daemon;

use strict;
use warnings;

use constant {
	KRB5_ADMIND_CONFIG	=> '/etc/krb5/krb5_admind.conf',
	ACL_FILE                => '/etc/krb5/krb5_admin.acl',
};

sub usage {

	print STDERR "Usage: krb5_admind [-M] [-a acl_file] [-d dbname] " .
	    "[-m master]\n";
	exit(1);
}

openlog('krb5_admind', 'pid', 'auth');

our $acl_file = ACL_FILE;
our $config = KRB5_ADMIND_CONFIG;
our $dbname;
our $sqlite;
our $allow_fetch;
our $master;
our $kmdb_class;
our %xrealm_bootstrap;
our %win_xrealm_bootstrap;
our %prestash_xrealm;

my %opts;
getopts('D:MPS:a:c:d:m:', \%opts) or usage();

$master   = hostname()		if  defined($opts{M});
$master   = $opts{m}		if !defined($master);
$acl_file = $opts{a}		if  defined($opts{a});
$dbname   = $opts{d}		if  defined($opts{d});
$dbname   = $opts{D}		if  defined($opts{D});
$sqlite   = $opts{S}		if  defined($opts{S});
$config   = $opts{c}		if  defined($opts{c});

if (-f $config || defined($opts{c})) {
	my $ret = do $config;
	die "Couldn't parse $config: $@\n"	if $@;
	die "Couldn't find $config\n"		if ! -f $config;
}

$kmdb_class = 'Krb5Admin::KerberosDB' if !defined($kmdb_class);

my %config;
$config{acl_file}		= $acl_file;
$config{config}			= $config;
$config{dbname}			= $dbname;
$config{sqlite}			= $sqlite;
$config{allow_fetch}		= $allow_fetch;
$config{master}			= $master;
$config{kmdb_class}		= $kmdb_class;
$config{xrealm_bootstrap}	= \%xrealm_bootstrap;
$config{win_xrealm_bootstrap}	= \%win_xrealm_bootstrap;
$config{prestash_xrealm}	= \%prestash_xrealm;
$config{preforked}		= $opts{P};

Krb5Admin::Daemon::run(\%config) or usage();
